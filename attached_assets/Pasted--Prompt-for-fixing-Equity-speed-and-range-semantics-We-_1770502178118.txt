## Prompt for fixing Equity speed and range semantics

We need to fix two major issues in the current PLO5 equity system:

1. **Performance is too slow**
2. **Villain range input like `10%` is not interpreted the same way as in ProPokerTools (PPT)**

Implement the following changes carefully.

---

### 1. Enable full CPU parallelism in Rust engine calls

In `server/equity.ts`, inside both:

* `spawnEquity()`
* `spawnBreakdown()`

always pass the threads argument to the Rust binary:

```
--threads auto
```

(or)

```
--threads ${process.env.EQUITY_THREADS ?? "auto"}
```

**Goal:**

* Ensure the Rust engine uses all available CPU cores.
* This should significantly reduce runtime for 300k–2M trials.

---

### 2. Fix villain range parsing to match PPT semantics

Currently the validator only accepts:

* `100%`
* `topN%`

We must support **PPT-style shorthand**:

* `10%` → must be interpreted as **top10%**
* `5%` → **top5%**
* `1%`, `3%`, `20%`, etc. → same logic

#### Required changes

**Regex validation must allow:**

```
^(100%|top\s*\d+(\.\d+)?%|\d+(\.\d+)?%)$
```

**Normalization logic:**

If the user enters:

```
10%
```

convert internally to:

```
top10%
```

before calling the Rust engine.

UI may still display `10%`,
but the backend must always pass **normalized `topN%`**.

---

### 3. Ensure correct sampling domain for top-percent ranges

When using `topN%`:

* Sampling must be done from the **full 2,598,960 combo universe**,
  **NOT** from 134,459 canonical hands.
* Use the existing:

```
rank_index_all_2598960.u32
```

* Blocker removal must still be applied.

This is required to match PPT-style equity behavior.

---

### 4. Show which engine is being used (critical for debugging)

On the Equity Calculator UI, add a small badge:

* If `EQUITY_ENGINE_URL` is set →
  **“Remote engine (VPS)”**
* Otherwise →
  **“Local engine (Replit)”**

This prevents confusion about where computation actually runs.

---

### 5. Expose performance diagnostics in results

Extend the equity API response and UI to show:

* `engineElapsedMs`
* `threadsUsed` (if available from Rust)
* `trials`
* whether computation was **remote or local**

This is essential for performance verification.

---

## Acceptance criteria

All of the following must be true:

1. **600k trials on VPS runs significantly faster** than local Replit execution.
2. Entering villain range **`10%` works** and is treated exactly like **`top10%`**.
3. Equity results match expected PPT-style behavior within normal Monte-Carlo error.
4. Breakdown works correctly even with shorthand board input like `"333"`.
5. UI clearly indicates **Remote vs Local engine**.

---

If anything is unclear, prioritize:

**correct PPT semantics → full CPU usage → remote execution clarity.**
